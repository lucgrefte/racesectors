<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Key Sectors</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .controls { margin-bottom: 1em; text-align: center; }
    .hidden { display: none; }
    .wind-arrow { display: inline-block; width: 16px; height: 16px; transform-origin: center; }
    .wind-arrow svg { width: 100%; height: 100%; transform: rotate(0deg); }
  </style>
</head>
<body>
  <h1 id="raceTitle">Key Sectors</h1>

  <div class="controls">
    <label><input type="checkbox" checked id="showClimbs"> Climbs</label>
    <label><input type="checkbox" checked id="showCobbles"> Cobbled Sectors</label>
    <label><input type="checkbox" checked id="showSprints"> Intermediate Sprints</label>
    <label><input type="checkbox" id="showTowns"> Town Markers</label>
    <br><br>
    <label>Start time: <input type="time" id="startTime" value="12:30"></label>
    <label>Avg. speed (km/h): <input type="number" id="avgSpeed" value="44" min="10" max="60"></label>
    <label>Select forecast date:
      <select id="forecastDate">
        <option value="2025-04-06">2025-04-06</option>
        <option value="2025-04-07">2025-04-07</option>
        <option value="2025-04-08">2025-04-08</option>
        <!-- Add more dates as necessary -->
      </select>
    </label>
    <button id="fetchWeather">Fetch Weather</button>
  </div>

  <table id="sectorsTable">
    <thead>
      <tr>
        <th>Type</th>
        <th>Name</th>
        <th>Start (km to go)</th>
        <th>End (km to go)</th>
        <th>ETA</th>
        <th>Icon</th>
        <th>Temp (Â°C)</th>
        <th>Wind (km/h)</th>
        <th>Wind Arrow</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const arrowSVG = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l6 8h-4v12h-4V10H6z" fill="black"/></svg>`;
  </script>

  <script>
    const tableBody = document.querySelector('#sectorsTable tbody');
    const titleEl = document.getElementById('raceTitle');
    const typeMap = {
      'stageclimbs': 'Climb',
      'stagecobbles': 'Cobbled Sector',
      'stagesprints': 'Sprint',
      'stagegenericsprints': 'Town',
      'start': 'Start',
      'finish': 'Finish'
    };
    const visibility = {
      'stageclimbs': true,
      'stagecobbles': true,
      'stagesprints': true,
      'stagegenericsprints': false,
      'start': true,
      'finish': true
    };

    document.getElementById('showClimbs').onchange = e => toggleType('stageclimbs', e.target.checked);
    document.getElementById('showCobbles').onchange = e => toggleType('stagecobbles', e.target.checked);
    document.getElementById('showSprints').onchange = e => toggleType('stagesprints', e.target.checked);
    document.getElementById('showTowns').onchange = e => toggleType('stagegenericsprints', e.target.checked);

    function toggleType(type, show) {
      visibility[type] = show;
      document.querySelectorAll(`tr[data-type*="${type}"]`).forEach(row => {
        row.style.display = show ? '' : 'none';
      });
    }

    function calculateETA(kmToGo, routeLength, startTime, avgSpeed) {
      const elapsedHours = (routeLength - kmToGo) / avgSpeed;
      return new Date(startTime.getTime() + elapsedHours * 3600000);
    }

    function bearing(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
      const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
      return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
    }

    const weatherEmojis = { 0: 'â˜€ï¸', 1: 'ðŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸', 45: 'ðŸŒ«ï¸', 48: 'ðŸŒ«ï¸',
      51: 'ðŸŒ¦ï¸', 53: 'ðŸŒ¦ï¸', 55: 'ðŸŒ§ï¸', 56: 'ðŸŒ§ï¸', 57: 'ðŸŒ§ï¸',
      61: 'ðŸŒ§ï¸', 63: 'ðŸŒ§ï¸', 65: 'ðŸŒ§ï¸', 66: 'ðŸŒ§ï¸', 67: 'ðŸŒ§ï¸',
      71: 'â„ï¸', 73: 'â„ï¸', 75: 'â„ï¸', 77: 'â„ï¸',
      80: 'ðŸŒ¦ï¸', 81: 'ðŸŒ§ï¸', 82: 'ðŸŒ§ï¸', 95: 'â›ˆï¸', 96: 'â›ˆï¸', 99: 'â›ˆï¸'
    };

    fetch('stage_data.json')
      .then(res => res.json())
      .then(data => {
        titleEl.textContent = data.trackname + ' Key Sectors';

        const routeLength = parseFloat(data.trackdistance);
        const mergedSectors = [];
        const routeCoords = data.route.map(p => [parseFloat(p.position.k), parseFloat(p.position.A)]);

        if (routeCoords.length > 1) {
          const start = routeCoords[0];
          const end = routeCoords[routeCoords.length - 1];
          mergedSectors.push({
            name: data.trackdepart,
            startKmToGo: routeLength,
            endKmToGo: routeLength,
            types: new Set(['start']),
            lat: start[0], lon: start[1]
          });
          mergedSectors.push({
            name: data.trackarrive,
            startKmToGo: 0,
            endKmToGo: 0,
            types: new Set(['finish']),
            lat: end[0], lon: end[1]
          });
        }

        const processSectors = (points, type) => {
          (points || []).forEach(point => {
            let d1 = parseFloat(point.startdistance ?? point.distance);
            let d2 = parseFloat(point.distance);
            const startKmToGo = routeLength - d1;
            const endKmToGo = routeLength - d2;
            const lat = parseFloat(point.location?.A);
            const lon = parseFloat(point.location?.F);

            mergedSectors.push
